<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Organic Pest Solution Recommender</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Simple, clean styling -->
    <style>
        body { font-family: Arial, sans-serif; margin: 24px; }
        .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        label { display: block; margin: 8px 0 4px; font-weight: 600; }
        select, input, button { padding: 8px; font-size: 14px; width: 100%; max-width: 420px; }
        button { cursor: pointer; border-radius: 8px; border: 1px solid #ccc; }
        table { border-collapse: collapse; width: 100%; margin-top: 12px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
        th { background: #f8f8f8; }
        .row { display: flex; gap: 20px; flex-wrap: wrap; }
        .half { flex: 1 1 380px; }
        .success { color: #1b7e1b; font-weight: 600; }
        .error { color: #b00020; font-weight: 600; }
    </style>
</head>
<body>
<h1>ðŸŒ¿ Organic Pest Solution Recommender</h1>

<!-- Selection form -->
<div class="card">
    <div class="row">
        <div class="half">
            <label for="crop">Crop</label>
            <select id="crop">
                <option value="">-- select crop --</option>
            </select>
        </div>
        <div class="half">
            <label for="symptom">Symptom</label>
            <select id="symptom" disabled>
                <option value="">-- select symptom --</option>
            </select>
        </div>
    </div>
    <div style="margin-top: 12px;">
        <button id="btnFind">Get Organic Remedy</button>
        <span id="msg" style="margin-left: 12px;"></span>
    </div>
</div>

<!-- Results table -->
<div class="card" id="resultsCard" style="display:none;">
    <h3>Recommended Remedies</h3>
    <table id="resultsTable">
        <thead>
        <tr>
            <th>Solution</th>
            <th>Dosage</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody><!-- Filled by JS --></tbody>
    </table>
</div>

<!-- Reporting block (to feed Power BI) -->
<div class="card" id="reportCard" style="display:none;">
    <h3>Report Usage (helps other farmers)</h3>
    <div class="row">
        <div class="half">
            <label for="location">Location (village/district)</label>
            <input type="text" id="location" placeholder="e.g., Mandya, Karnataka" />
        </div>
        <div class="half">
            <label for="severity">Severity</label>
            <select id="severity">
                <option value="">-- select --</option>
                <option>LOW</option>
                <option>MEDIUM</option>
                <option>HIGH</option>
            </select>
        </div>
    </div>
    <p style="margin-top:10px;">Select a remedy below and click <b>Submit Report</b>.</p>
    <button id="btnReport">Submit Report</button>
    <span id="reportMsg" style="margin-left: 12px;"></span>
</div>

<script>
    const cropSel = document.getElementById('crop');
    const symptomSel = document.getElementById('symptom');
    const btnFind = document.getElementById('btnFind');
    const msg = document.getElementById('msg');
    const resultsCard = document.getElementById('resultsCard');
    const resultsTableBody = document.querySelector('#resultsTable tbody');
    const reportCard = document.getElementById('reportCard');
    const btnReport = document.getElementById('btnReport');
    const locationInput = document.getElementById('location');
    const severitySel = document.getElementById('severity');
    const reportMsg = document.getElementById('reportMsg');

    // Keep selected remedy in memory for reporting
    let lastRemedies = [];
    let selectedRemedy = null;

    // Helper: create option element
    function opt(v) {
      const o = document.createElement('option');
      o.value = v; o.textContent = v;
      return o;
    }

    // Load crops on page load
    async function loadCrops() {
      try {
        const res = await fetch('/api/crops');
        const crops = await res.json();
        crops.forEach(c => cropSel.appendChild(opt(c)));
      } catch (e) {
        msg.textContent = 'Failed to load crops';
        msg.className = 'error';
      }
    }

    // When crop changes, load symptoms
    cropSel.addEventListener('change', async () => {
      symptomSel.innerHTML = '<option value="">-- select symptom --</option>';
      symptomSel.disabled = true;
      const crop = cropSel.value;
      if (!crop) return;
      try {
        const res = await fetch(`/api/symptoms?crop=${encodeURIComponent(crop)}`);
        const symptoms = await res.json();
        symptoms.forEach(s => symptomSel.appendChild(opt(s)));
        symptomSel.disabled = false;
      } catch (e) {
        msg.textContent = 'Failed to load symptoms';
        msg.className = 'error';
      }
    });

    // Search for remedies
    btnFind.addEventListener('click', async () => {
      msg.textContent = '';
      resultsCard.style.display = 'none';
      reportCard.style.display = 'none';
      resultsTableBody.innerHTML = '';
      selectedRemedy = null;

      const crop = cropSel.value;
      const symptom = symptomSel.value;
      if (!crop || !symptom) {
        msg.textContent = 'Please select both crop and symptom.';
        msg.className = 'error';
        return;
      }

      try {
        const res = await fetch(`/api/remedies?crop=${encodeURIComponent(crop)}&symptom=${encodeURIComponent(symptom)}`);
        lastRemedies = await res.json();

        if (!Array.isArray(lastRemedies) || lastRemedies.length === 0) {
          msg.textContent = 'No organic remedy found for this selection.';
          msg.className = 'error';
          return;
        }

        // Render table
        lastRemedies.forEach((r, idx) => {
          const tr = document.createElement('tr');

          const tdSolution = document.createElement('td');
          tdSolution.textContent = r.solution;

          const tdDosage = document.createElement('td');
          tdDosage.textContent = r.dosage;

          const tdAction = document.createElement('td');
          const chooseBtn = document.createElement('button');
          chooseBtn.textContent = 'Choose for Report';
          chooseBtn.addEventListener('click', () => {
            selectedRemedy = r; // pick remedy
            reportCard.style.display = 'block';
            reportMsg.textContent = `Selected: ${r.solution} (${r.dosage})`;
            reportMsg.className = '';
          });
          tdAction.appendChild(chooseBtn);

          tr.appendChild(tdSolution);
          tr.appendChild(tdDosage);
          tr.appendChild(tdAction);
          resultsTableBody.appendChild(tr);
        });

        resultsCard.style.display = 'block';
        msg.textContent = `${lastRemedies.length} remedy(s) found.`;
        msg.className = 'success';
      } catch (e) {
        msg.textContent = 'Error while fetching remedies.';
        msg.className = 'error';
      }
    });

    // Submit report to backend (feeds Power BI)
    btnReport.addEventListener('click', async () => {
      reportMsg.textContent = '';
      if (!selectedRemedy) {
        reportMsg.textContent = 'Please select a remedy first.';
        reportMsg.className = 'error';
        return;
      }
      const payload = {
        crop: cropSel.value,
        symptom: symptomSel.value,
        chosenSolution: selectedRemedy.solution,
        location: locationInput.value || null,
        severity: severitySel.value || null
      };

      try {
        const res = await fetch('/api/reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Failed');
        const id = await res.json();
        reportMsg.textContent = `Report submitted (ID: ${id}). Thank you!`;
        reportMsg.className = 'success';
      } catch (e) {
        reportMsg.textContent = 'Failed to submit report.';
        reportMsg.className = 'error';
      }
    });

    loadCrops();
</script>
</body>
</html>